#!/bin/bash

while getopts ":i:g:e:" Option
do
  case $Option in
    i ) _uid=$OPTARG ;;
    g ) _gid=$OPTARG ;;
  esac
done
shift $(($OPTIND - 1))

if [[ $# -lt 4 ]]; then
  echo "Usage: add-tm-account [ -i uid -g gid ] USERNAME PASSWORD VOL_NAME [VOL_SIZE_MB]"
  exit 1
fi

if [[ ${_uid} ]] && [[ ${_gid} ]]; then
  addgroup -g "${_gid}" "$1"
  adduser  -u "${_uid}" -S -H "${1}"
else
  adduser -S -H -G root "${1}"
fi

echo "${1}:${2}" | chpasswd

# Set proper uid:gid to mountpoint
if [[ ${_uid} ]] && [[ ${_gid} ]]; then
    chown -R "${_uid}:${_gid}" /timemachine
else
    chown -R "${1}":root /timemachine
fi

# Add config to timemachine
  echo "
[${3}]
    path = /timemachine
    time machine = yes
    valid users = ${1}
    spotlight = no" >> /etc/afp.conf

if [[ $# -eq 4 ]]; then
  echo "vol size limit = ${4}" >> /etc/afp.conf
fi

pkill -HUP afpd
exit 0
